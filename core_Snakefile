#This pipeline requires Mafft, iqtree, pal2nal and palm. It also requires Python3 with biopython and pandas.
configfile: 'config.yml'
import os

def get_files(path_to_files, term = '0.faa'):
    faa = [f'{path_to_files}/{file}' for file in os.listdir(path_to_files) if file.endswith(term)]
    return faa

def get_aln_files(file_list):
    aln_files = [f'{file.replace(".faa", ".mafft.faa")}' for file in file_list]
    return aln_files

def get_pal2nal(path_to_files, outpath, term = 'pal2nal'):
    infiles = [file.replace('.fna', '') for file in os.listdir(path_to_files) if file.endswith('.fna')]
    outfiles = [f'{outpath}/{file}.{term}' for file in infiles]
    return outfiles

def get_CodeML(path_to_files = 'all_core/codons', base_outpath = 'all_core/results', term = 'txt'):
    infiles = [file.replace('.pal2nal', '') for file in os.listdir(path_to_files) if file.endswith('.pal2nal')]
    outfiles = [f'{base_outpath}/{file}/{file}.{term}' for file in infiles]
    return outfiles

def get_parsed(path_to_files = 'all_core/codons', base_outpath = 'all_core/results', ext = 'dNdS.tsv'):
    infiles = [file.replace('.pal2nal', '') for file in os.listdir(path_to_files) if file.endswith('.pal2nal')]
    outfiles = [f'{base_outpath}/{file}/{ext}' for file in infiles]
    print(outfiles)
    return outfiles

rule mafft:
        input: 
                get_files('all_core/fasta')
        output: 
                get_aln_files(get_files('all_core/fasta'))
        conda: 'envs/environment.yml'
        threads: 8
        shell:
                """
                for file in {input};
                do
                outfile=${{file/.faa/.mafft.faa}}
                mafft-linsi --thread {threads} $file > $outfile;
                done
                """

rule pal2nal:
	input:
		aln1 = get_aln_files(get_files('all_core/fasta')),
		aln2 = get_files('all_core/fasta', '.fna')
	output:
		get_pal2nal('all_core/fasta', 'all_core/codons')
	threads: 2
        shell:
		"""
                mkdir -p all_core/codons
                for file in {input.aln2};
                do
                file2=${{file/.fna/.mafft.faa}}
                outfile=${{file/fasta/codons}}
                outfile=${{outfile/.fna/.pal2nal}}
                pal2nal.v14/pal2nal.pl $file2 $file -output paml -nogap > $outfile
                done
                """

rule codeml_exe:
	input:
		get_pal2nal('all_core/fasta', 'all_core/codons'),
		'trees/empty.tree'
	output:
                outdir = directory('all_core/results'), 
                outfiles = get_CodeML()  #'results/core_genes/{gnrl}/{gnrl}.txt"
	threads: 1
        log: 'logs/python/all_codeml.log'
        conda: 'envs/environment.yml'
	script: 
                'code/core_pipeline/all_core/04-codeml_core.py'
		
rule run_parser:
	input:
		txt = get_CodeML()
	output:
		dNdS = get_parsed(ext = 'dNdS.tsv'),
		stats = get_parsed(ext = 'stats.tsv')
	threads: 1
        log: 'logs/python/parse_codeml.log'
        conda: 'envs/environment.yml'
	script:
		'code/core_pipeline/all_core/05-parse_codeml.py'

